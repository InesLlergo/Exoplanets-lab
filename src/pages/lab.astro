---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Laboratorio de Tránsito - Simulación Completa">
  
  <style is:global>
    body {
      display: block;
      overflow-x: hidden;
    }
  </style>

  <style>
    .lab-page{width:100%;min-height:100vh;padding:1.5rem;box-sizing:border-box;display:flex;flex-direction:column;animation:fadeIn .8s ease-in-out}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}.lab-header{text-align:center;margin-bottom:2rem;flex-shrink:0}.lab-header h1{font-size:clamp(1.8rem, 4vw, 2.5rem);margin-bottom:.5rem}.lab-header p{max-width:700px;color:#9ca3af;margin:0 auto 1.5rem;font-size:clamp(.9rem, 2vw, 1rem)}.lab-grid{display:grid;grid-template-columns:1fr 340px;gap:2rem;width:100%;max-width:1600px;margin:0 auto;flex-grow:1}@media (max-width: 960px){.lab-page{padding:1rem}.lab-grid{grid-template-columns:1fr}.ui-panel{order:-1}}.simulation-wrapper{display:flex;flex-direction:column;gap:1rem;min-width:0}.canvas-container{position:relative;background:#071025;border-radius:12px;box-shadow:0 8px 25px rgba(0,0,0,.5);overflow:hidden}#view{width:100%;aspect-ratio:1 / 1}#plot{width:100%;aspect-ratio:3 / 1}.ui-panel{background:rgba(17,24,39,.6);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.1);border-radius:1rem;padding:1.5rem;display:flex;flex-direction:column;gap:1rem;height:fit-content}.ui-panel fieldset{border:1px solid rgba(255,255,255,.1);border-radius:.5rem;padding:1rem;margin:0;display:flex;flex-direction:column;gap:.75rem}.ui-panel legend{padding:0 .5rem;font-size:1rem;font-weight:600;color:#9ca3af}.control-row{display:grid;grid-template-columns:1fr auto;align-items:center}.control-row label{font-size:.9rem;color:#d1d5db}input[type=range]{-webkit-appearance:none;appearance:none;width:100%;grid-column:1 / -1;margin-top:.25rem;background:transparent}input[type=range]:focus{outline:0}input[type=range]::-webkit-slider-runnable-track{height:6px;background:rgba(0,0,0,.3);border-radius:3px}input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;height:18px;width:18px;border-radius:50%;background:#6366f1;cursor:pointer;margin-top:-6px;border:2px solid #e0e7ff}#results{background:rgba(0,0,0,.2);padding:1rem;border-radius:.5rem;font-size:.85rem;line-height:1.7;border-left:3px solid #6366f1}.lab-footer{width:100%;text-align:center;margin-top:auto;padding-top:2rem;color:#6b7280;font-size:.9rem}a.back-btn{text-decoration:none}.description-text{font-size:.85rem;color:#9ca3af;text-align:center;padding:0 1rem .5rem}
  </style>

  <div class="lab-page">
    <header class="lab-header">
      <h1>Simulador de Tránsito Exoplanetario</h1>
      <p>
        Una herramienta interactiva para visualizar el método de tránsito, una técnica clave en la detección de planetas fuera de nuestro sistema solar.
      </p>
      <a href="/" class="back-btn">Volver al Menú Principal</a>
    </header>

    <main class="lab-grid">
      <div class="simulation-wrapper">
        <div class="canvas-container">
          <canvas id="view"></canvas>
        </div>
        <div class="canvas-container">
          <canvas id="plot"></canvas>
        </div>
      </div>

      <aside class="ui-panel">
        <div style="display: flex; gap: 0.5rem;">
          <button id="play" style="width: 100%;">▶️ Reproducir</button>
          <button id="reset" style="width: 100%;">↺ Reiniciar</button>
        </div>
        
        <fieldset>
          <legend>Simulación</legend>
          <div class="control-row">
            <label for="speed">Velocidad de simulación</label>
            <span id="speedVal">1</span>x
          </div>
          <input id="speed" type="range" min="0.1" max="10" step="0.1" value="1">
        </fieldset>

        <fieldset>
          <legend>Planeta</legend>
          <div class="control-row">
            <label for="mass">Masa (M⊕)</label>
            <span id="massVal">1</span>
          </div>
          <input id="mass" type="range" min="0.1" max="500" step="0.1" value="1">

          <div class="control-row">
            <label for="radius">Radio (R⊕)</label>
            <span id="rVal">1</span>
          </div>
          <input id="radius" type="range" min="0.1" max="20" step="0.1" value="1">

          <div class="control-row">
            <label for="period">Periodo (días)</label>
            <span id="perVal">365</span>
          </div>
          <input id="period" type="range" min="10" max="2000" value="365">
          
          <div class="control-row">
            <label for="a">Semieje Mayor (AU)</label>
            <span id="aVal">1</span>
          </div>
          <input id="a" type="range" min="0.1" max="5" step="0.01" value="1">

          <div class="control-row">
            <label for="incl">Inclinación (°)</label>
            <span id="inclVal">89</span>
          </div>
          <input id="incl" type="range" min="0" max="90" step="0.1" value="89">
        </fieldset>
        
        <fieldset>
          <legend>Estrella central</legend>
          <div class="control-row">
            <label for="starR">Radio estelar (R☉)</label>
            <span id="starRVal">1</span>
          </div>
          <input id="starR" type="range" min="0.5" max="2" step="0.01" value="1">
        </fieldset>
        
        <p class="description-text">La gráfica muestra el brillo total y los tránsitos detectados.</p>
        <div id="results">Esperando datos...</div>
      </aside>
    </main>

    <footer class="lab-footer">
      Laboratorio Interactivo de Aventura Espacial
    </footer>
  </div>

  <script>
    const view=document.getElementById("view"),plot=document.getElementById("plot");function resizeCanvas(){[view,plot].forEach(e=>{e.width=e.clientWidth,e.height=e.clientHeight}),draw()}const ctx=view.getContext("2d"),pctx=plot.getContext("2d"),resDiv=document.getElementById("results");let t=0,playing=!1,speed=1,incl=1.5533430342749532;const AU=1.496e11,day=86400,R_sun=6.957e8,R_earth=6.371e6,M_earth=5.972e24,G=6.6743e-11,M_sun=1.989e30;let planet={color:"#4ec9ff",mass:1,period:365,a:1,r:1};let times=[],fluxes=[],maxPoints=800;function planetPosition(e,t){const a=t*Math.cos(e),s=t*Math.sin(e)*Math.cos(incl),l=t*Math.sin(e)*Math.sin(incl);return{x:a,y:s,z:l}}function circleOverlapArea(e,t,a){if(a>=e+t)return 0;if(a<=Math.abs(e-t))return Math.PI*Math.min(e,t)**2;const s=e*e,l=t*t,n=a*a;return s*Math.acos((n+s-l)/(2*a*e))+l*Math.acos((n+l-s)/(2*a*t))-.5*Math.sqrt((-a+t+e)*(a+t-e)*(a-t+e)*(a+t+e))}function computeFlux(e){const{y:t,z:a}=planetPosition(e,planet.a),s=Math.hypot(t,a),l=R_sun*Number(document.getElementById("starR").value),n=circleOverlapArea(l,planet.r*R_earth,s*AU);return 1-n/(Math.PI*l*l)}function drawPlot(){pctx.clearRect(0,0,plot.width,plot.height);if(!fluxes.length)return;pctx.strokeStyle="rgba(167, 139, 250, 1)",pctx.lineWidth=2;const e=plot.width,t=plot.height,a=fluxes.length,s=Math.min(...fluxes),l=1-s,n=s-.1*l,r=1+.1*l;pctx.beginPath();for(let o=0;o<a;o++){const a=o/(maxPoints-1)*e,s=t-(fluxes[o]-n)/(r-n)*t;0===o?pctx.moveTo(a,s):pctx.lineTo(a,s)}pctx.stroke()}function analyzePlanet(){const e=Math.min(...fluxes)||1,t=R_sun*Number(document.getElementById("starR").value);let a=Math.sqrt(1-e)*t/R_earth;a=isNaN(a)?"---":a.toFixed(2);const s=planet.a*AU,l=planet.period*day,n=(4*Math.PI**2*s**3/(G*l**2)/M_sun*333000).toFixed(2);let r;planet.r<1.5?r="Rocoso":planet.r<4?r="Neptuniano":r="Joviano";const o=(planet.r*R_earth/t)**2,c=5778*Math.pow(Number(document.getElementById("starR").value),-.5),d=c*Math.sqrt(t/(2*s))*Math.pow(.7,.25);resDiv.innerHTML=`<strong>Radio estimado:</strong> ${a} R⊕<br><strong>Masa estimada:</strong> ${n} M⊕<br><strong>Tipo:</strong> ${r}<br><strong>Profundidad de tránsito:</strong> ${(100*o).toFixed(4)} %<br><strong>Temperatura de equilibrio:</strong> ${d.toFixed(0)} K`}function draw(){if(0===view.width)return;ctx.clearRect(0,0,view.width,view.height);const e=view.width/2,t=view.height/2,a=t/planet.period*2*Math.PI,s=Math.min(view.width,view.height)/2.5,l=Math.max(10,s*.2*Number(document.getElementById("starR").value)),n=planet.a*s;const r=ctx.createRadialGradient(e,t,.1*l,e,t,l);r.addColorStop(0,"#fff"),r.addColorStop(.8,"#ffd28f"),r.addColorStop(1,"#ffad57"),ctx.fillStyle=r,ctx.beginPath(),ctx.arc(e,t,l,0,2*Math.PI),ctx.fill(),ctx.strokeStyle="rgba(255,255,255,0.15)",ctx.setLineDash([5,10]),ctx.beginPath(),ctx.ellipse(e,t,n,n*Math.cos(incl),0,0,2*Math.PI),ctx.stroke(),ctx.setLineDash([]);const o=e+n*Math.cos(a),c=t+n*Math.sin(a)*Math.cos(incl),d=Math.max(2,l*planet.r*R_earth/(Number(document.getElementById("starR").value)*R_sun));ctx.fillStyle=planet.color,ctx.beginPath(),ctx.arc(o,c,d,0,2*Math.PI),ctx.fill(),drawPlot(),analyzePlanet()}function step(e){step.last||(step.last=e);const a=(e-step.last)/1e3;step.last=e,playing&&(t+=a*speed,fluxes.push(computeFlux(t/planet.period*2*Math.PI)),fluxes.length>maxPoints&&fluxes.shift()),draw(),requestAnimationFrame(step)}function updateUI(){speed=Number(document.getElementById("speed").value),planet.mass=Number(document.getElementById("mass").value),planet.period=Number(document.getElementById("period").value),planet.a=Number(document.getElementById("a").value),planet.r=Number(document.getElementById("radius").value),incl=Number(document.getElementById("incl").value)*Math.PI/180;const e=document.getElementById("starR").value;document.getElementById("speedVal").textContent=speed,document.getElementById("massVal").textContent=planet.mass,document.getElementById("perVal").textContent=planet.period,document.getElementById("aVal").textContent=planet.a,document.getElementById("rVal").textContent=planet.r,document.getElementById("inclVal").textContent=Number(document.getElementById("incl").value),document.getElementById("starRVal").textContent=e,draw()}document.querySelectorAll('input[type="range"]').forEach(e=>e.addEventListener("input",updateUI)),document.getElementById("play").addEventListener("click",()=>{playing=!playing,document.getElementById("play").textContent=playing?"⏸️ Pausar":"▶️ Reproducir"}),document.getElementById("reset").addEventListener("click",()=>{t=0,fluxes=[],draw()}),window.addEventListener("resize",resizeCanvas),resizeCanvas(),updateUI(),requestAnimationFrame(step);
  </script>
</Layout>